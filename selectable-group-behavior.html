<link rel="import" href="../polymer/polymer-element.html">

<script>

window.SelectableGroupBehavior = subclass => class extends Polymer.Element {

  static get properties() {
    return {

      /**
        * The list of selectable-item
        */
      items: {
        type: Array,
        readOnly: true,
        notify: true,
        value: function() {
          return [];
        }
      },

      activeSelection: {
        type: Boolean,
        value: false,
        notify: true,
        observer: '_activeSelectionChanged'
      }

    };
  }

  get selection() {
    return this.items.filter(item => item.selected);
  }

  constructor() {
    super();

    this._observer = null;
    this._onItemSelectedChange = this._onItemSelectedChange.bind(this);
    this._onKeydown = this._onKeydown.bind(this);
  }

  connectedCallback() {
    super.connectedCallback();

    requestAnimationFrame(_ => {
      this._updateItems();
      this._observer = this._observeItems(this);
      this._toggleListeners({enable: true});
    });
  }

  disconnectedCallback() {
    super.disconnectedCallback();

    this._toggleListeners({enable: false});
    this._observer.disconnect();
    this._observer = null;
  }

  _onItemSelectedChange() {
    this.activeSelection = Boolean(this.selection.length);
  }

  _activeSelectionChanged() {
    this.items.forEach(item => {
      item.selectOnDown = this.activeSelection;
    });
  }

  _onKeydown(event) {
    const escKey = 27;

    if (event.keyCode === escKey) {
      this.selection.forEach(item => {
        item.selected = false;
      });
    }
  }

  _toggleListeners({enable}) {
    const m = enable ? 'addEventListener' : 'removeEventListener';

    this[m]('item-selected-change', this._onItemSelectedChange);
    document.body[m]('keydown', this._onKeydown);
  }

  _observeItems(node) {
    return new MutationObserver(mutations => {
      this._updateItems();
    }).observe(this, {subtree: true, childList: true});
  }

  _updateItems() {
    const nodes = Array.from(this.querySelectorAll('selectable-item'));
    this._setItems(nodes);
  }

}

</script>